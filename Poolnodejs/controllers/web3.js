
var Web3 = require("web3");

if (typeof web3 !== 'undefined') {
  web3 = new Web3(web3.currentProvider);
} else {
  // set the provider you want from Web3.providers
  web3 = new Web3(new Web3.providers.HttpProvider("http://localhost:8545"));
}

var primaryAddress = web3.eth.accounts[0];

var abi =[{"constant":true,"inputs":[],"name":"name","outputs":[{"name":"","type":"bytes32"}],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"nombre","type":"bytes32"},{"name":"aspirante","type":"bytes32"}],"name":"vota","outputs":[],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"encuesta","type":"bytes32"}],"name":"devuelvePuntuaciones","outputs":[{"name":"values","type":"uint256[]"}],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"encuesta","type":"bytes32"}],"name":"devuelveEncuestados","outputs":[{"name":"encuestados","type":"bytes32[]"}],"payable":false,"type":"function"},{"constant":true,"inputs":[{"name":"","type":"bytes32"}],"name":"votaciones","outputs":[{"name":"nombre","type":"bytes32"}],"payable":false,"type":"function"},{"constant":false,"inputs":[],"name":"devuelveTodasEncuestas","outputs":[{"name":"","type":"bytes32[]"}],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"nombre","type":"bytes32"},{"name":"aspirantes","type":"bytes32[]"},{"name":"puntuaciones","type":"uint256[]"}],"name":"createVotacion","outputs":[],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"nombre","type":"bytes32"}],"name":"eliminarVotacion","outputs":[],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"rol","type":"bytes32"}],"name":"registraToken","outputs":[{"name":"a","type":"bytes32"}],"payable":false,"type":"function"},{"constant":true,"inputs":[{"name":"","type":"address"}],"name":"tokens","outputs":[{"name":"","type":"bytes32"}],"payable":false,"type":"function"},{"constant":false,"inputs":[],"name":"devuelveToken","outputs":[{"name":"t","type":"bytes32"}],"payable":false,"type":"function"},{"inputs":[{"name":"_name","type":"bytes32"}],"payable":false,"type":"constructor"},{"anonymous":false,"inputs":[{"indexed":false,"name":"","type":"bytes32"}],"name":"DevuelveBytes","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"","type":"uint256"}],"name":"DevuelveUint","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"","type":"address"}],"name":"DevuelveAddr","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"","type":"address[]"}],"name":"DevuelveArrayAddress","type":"event"}];
var code = "0x606060405273950a13dc7a79187e519e6d7d5d5e1065fe9d35a2600560006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550600560009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16600660006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555034156100c457fe5b604051602080611727833981016040528080519060200190919050505b80600081600019169055505b505b611629806100fe6000396000f300606060405236156100ad576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff16806306fdde03146100af5780630878424f146100dd57806322fefe311461010e57806325ce77a0146101955780635ab993731461021c5780635ac26ebd1461025c578063663d1e84146102d15780636641cc271461037557806396023cbf14610399578063e4860339146103d9578063f151e4ae1461042b575bfe5b34156100b757fe5b6100bf610459565b60405180826000191660001916815260200191505060405180910390f35b34156100e557fe5b61010c6004808035600019169060200190919080356000191690602001909190505061045f565b005b341561011657fe5b610130600480803560001916906020019091905050610a29565b6040518080602001828103825283818151815260200191508051906020019060200280838360008314610182575b8051825260208311156101825760208201915060208101905060208303925061015e565b5050509050019250505060405180910390f35b341561019d57fe5b6101b7600480803560001916906020019091905050610aa9565b6040518080602001828103825283818151815260200191508051906020019060200280838360008314610209575b805182526020831115610209576020820191506020810190506020830392506101e5565b5050509050019250505060405180910390f35b341561022457fe5b61023e600480803560001916906020019091905050610b2d565b60405180826000191660001916815260200191505060405180910390f35b341561026457fe5b61026c610b4b565b60405180806020018281038252838181518152602001915080519060200190602002808383600083146102be575b8051825260208311156102be5760208201915060208101905060208303925061029a565b5050509050019250505060405180910390f35b34156102d957fe5b6103736004808035600019169060200190919080359060200190820180359060200190808060200260200160405190810160405280939291908181526020018383602002808284378201915050505050509190803590602001908201803590602001908080602002602001604051908101604052809392919081815260200183836020028082843782019150505050505091905050610bae565b005b341561037d57fe5b610397600480803560001916906020019091905050610f09565b005b34156103a157fe5b6103bb60048080356000191690602001909190505061106c565b60405180826000191660001916815260200191505060405180910390f35b34156103e157fe5b61040d600480803573ffffffffffffffffffffffffffffffffffffffff16906020019091905050611243565b60405180826000191660001916815260200191505060405180910390f35b341561043357fe5b61043b61125b565b60405180826000191660001916815260200191505060405180910390f35b60005481565b600060006000600060006003600088600019166000191681526020019081526020016000206001018054905014156106265760036000876000191660001916815260200190815260200160002060010180548060010182816104c1919061130e565b916000526020600020900160005b6000909190916101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550507f7b81e7a415380da8c6a8c7b97e3884ab373d9ca9c82d920ec652efdc6cdd12fa600360008860001916600019168152602001908152602001600020600101805490506040518082815260200191505060405180910390a17fbd3b08ea294a1a3f5416574afd6a3be5de58575a6b957f15756d5dacb9b8b5c060036000886000191660001916815260200190815260200160002060010160008154811015156105b757fe5b906000526020600020900160005b9054906101000a900473ffffffffffffffffffffffffffffffffffffffff16604051808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390a15b600093505b6003600087600019166000191681526020019081526020016000206001018054905084101561072b573373ffffffffffffffffffffffffffffffffffffffff166003600088600019166000191681526020019081526020016000206001018581548110151561069657fe5b906000526020600020900160005b9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16141561071d577f7b81e7a415380da8c6a8c7b97e3884ab373d9ca9c82d920ec652efdc6cdd12fa610bb86040518082815260200191505060405180910390a1610a21565b5b838060010194505061062b565b600092505b60036000876000191660001916815260200190815260200160002060020180549050831015610a205784600019166003600088600019166000191681526020019081526020016000206002018481548110151561078957fe5b906000526020600020900160005b5054600019161415610a1257600360008760001916600019168152602001908152602001600020600301838154811015156107ce57fe5b906000526020600020900160005b505491508180600101925050816003600088600019166000191681526020019081526020016000206003018481548110151561081457fe5b906000526020600020900160005b50819055507f7b81e7a415380da8c6a8c7b97e3884ab373d9ca9c82d920ec652efdc6cdd12fa6003600088600019166000191681526020019081526020016000206003018481548110151561087357fe5b906000526020600020900160005b50546040518082815260200191505060405180910390a160036000876000191660001916815260200190815260200160002060010190508080548060010182816108cb919061130e565b916000526020600020900160005b33909190916101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550508060036000886000191660001916815260200190815260200160002060010190805461094892919061133a565b507f059cb3cee981fcac001d90eb04b8fec09a2d0595bd2124f8ac74a703f8e4ef8460036000886000191660001916815260200190815260200160002060010160405180806020018281038252838181548152602001915080548015610a0357602002820191906000526020600020905b8160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190600101908083116109b9575b50509250505060405180910390a15b5b8280600101935050610730565b5b505050505050565b610a3161138c565b600360008360001916600019168152602001908152602001600020600301805480602002602001604051908101604052809291908181526020018280548015610a9957602002820191906000526020600020905b815481526020019060010190808311610a85575b505050505090508090505b919050565b610ab16113a0565b600360008360001916600019168152602001908152602001600020600201805480602002602001604051908101604052809291908181526020018280548015610b1d57602002820191906000526020600020905b81546000191681526020019060010190808311610b05575b505050505090508090505b919050565b60036020528060005260406000206000915090508060000154905081565b610b536113a0565b6001805480602002602001604051908101604052809291908181526020018280548015610ba357602002820191906000526020600020905b81546000191681526020019060010190808311610b8b575b505050505090505b90565b600660009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1663f0ecadaf336000604051602001526040518263ffffffff167c0100000000000000000000000000000000000000000000000000000000028152600401808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001807f676572656e746500000000000000000000000000000000000000000000000000815250602001915050602060405180830381600087803b1515610c9857fe5b6102c65a03f11515610ca657fe5b5050506040518051905015610f0357608060405190810160405280846000191681526020016002805480602002602001604051908101604052809291908181526020018280548015610d4d57602002820191906000526020600020905b8160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019060010190808311610d03575b5050505050815260200183815260200182815250600360008560001916600019168152602001908152602001600020600082015181600001906000191690556020820151816001019080519060200190610da89291906113b4565b506040820151816002019080519060200190610dc592919061143e565b506060820151816003019080519060200190610de2929190611491565b5090505060018054806001018281610dfa91906114de565b916000526020600020900160005b85909190915090600019169055507f8f6c2a63fc88962d69041439b2e0d78a98ba43644aa8579ae0897631d5cbecef6003600085600019166000191681526020019081526020016000206002016000815481101515610e6357fe5b906000526020600020900160005b505460405180826000191660001916815260200191505060405180910390a17f7b81e7a415380da8c6a8c7b97e3884ab373d9ca9c82d920ec652efdc6cdd12fa6003600085600019166000191681526020019081526020016000206003016000815481101515610edd57fe5b906000526020600020900160005b50546040518082815260200191505060405180910390a15b5b505050565b600660009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1663f0ecadaf336000604051602001526040518263ffffffff167c0100000000000000000000000000000000000000000000000000000000028152600401808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001807f7374616666000000000000000000000000000000000000000000000000000000815250602001915050602060405180830381600087803b1515610ff357fe5b6102c65a03f1151561100157fe5b50505060405180519050156110685760036000826000191660001916815260200190815260200160002060006000820160009055600182016000611045919061150a565b600282016000611055919061152c565b600382016000611065919061154e565b50505b5b50565b60004233604051808381526020018273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166c01000000000000000000000000028152601401925050506040518091039020905080600460003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002081600019169055507f8f6c2a63fc88962d69041439b2e0d78a98ba43644aa8579ae0897631d5cbecef8160405180826000191660001916815260200191505060405180910390a1600660009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16639de18f9c3383856040518463ffffffff167c0100000000000000000000000000000000000000000000000000000000028152600401808473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001836000191660001916815260200182600019166000191681526020019350505050600060405180830381600087803b151561122957fe5b6102c65a03f1151561123757fe5b5050508090505b919050565b60046020528060005260406000206000915090505481565b6000600460003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000205490507f3078300000000000000000000000000000000000000000000000000000000000600460003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002081600019169055508090505b90565b815481835581811511611335578183600052602060002091820191016113349190611570565b5b505050565b82805482825590600052602060002090810192821561137b5760005260206000209182015b8281111561137a57825482559160010191906001019061135f565b5b5090506113889190611595565b5090565b602060405190810160405280600081525090565b602060405190810160405280600081525090565b82805482825590600052602060002090810192821561142d579160200282015b8281111561142c5782518260006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550916020019190600101906113d4565b5b50905061143a9190611595565b5090565b828054828255906000526020600020908101928215611480579160200282015b8281111561147f57825182906000191690559160200191906001019061145e565b5b50905061148d91906115d8565b5090565b8280548282559060005260206000209081019282156114cd579160200282015b828111156114cc5782518255916020019190600101906114b1565b5b5090506114da9190611570565b5090565b8154818355818115116115055781836000526020600020918201910161150491906115d8565b5b505050565b50805460008255906000526020600020908101906115289190611570565b5b50565b508054600082559060005260206000209081019061154a91906115d8565b5b50565b508054600082559060005260206000209081019061156c9190611570565b5b50565b61159291905b8082111561158e576000816000905550600101611576565b5090565b90565b6115d591905b808211156115d157600081816101000a81549073ffffffffffffffffffffffffffffffffffffffff02191690555060010161159b565b5090565b90565b6115fa91905b808211156115f65760008160009055506001016115de565b5090565b905600a165627a7a72305820eb77fe036bc15efaa80a795b396afe0058df71ceb12e98cc765c7a216a1615650029";

var MyContract = web3.eth.contract(abi);

/**
 * Asignar y configurar el servidor Socket.io por el que enviar mensajes notificando de cambios en aforos.
 */
function setIO(io) {

	io.on('connection', function (socket) {

		var events = [];

		socket.on('addr', function (data) {

			data.sites.forEach(function(site) {

	    		var contractInstance = MyContract.at(site.address);

	    		events.push(contractInstance.Counter(function(err, data) {
	    			if (!err) {
						socket.emit('counter', { id: site.id,
							                     name: data.args._name,
						                         counter: data.args._counter });
	    			}
				}));

	    		events.push(contractInstance.Alarm(function(err, data) {
	    			if (!err) {
						socket.emit('alarm', { id: site.id,
							                   name: data.args._name,
						                       counter: data.args._counter });
	    			}
				}));
			});

		});

		socket.on('disconnect', function () {
			events.forEach(function(event) {event.stopWatching();});
		});
	});
}



exports.web3 = web3;
exports.primaryAddress = primaryAddress;
exports.abi = abi;
exports.code = code;
exports.MyContract = MyContract;
exports.setIO = setIO;
